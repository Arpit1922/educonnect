<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edu Connect â€” Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#004ad0;
      --bg:#f2f5f7;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --success:#198754;
      --error:#d93025;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Poppins, Inter, system-ui, -apple-system, Arial, sans-serif;
      background:var(--bg);color:var(--text);transition:background .3s,color .3s;
      -webkit-font-smoothing:antialiased;
    }
    body.dark{
      --bg:#0f1113; --card:#141618; --text:#e6eef8; --muted:#9aa4b2; --brand:#3a82ff;
    }
    header{ background:var(--brand); color:#fff; padding:18px 16px; position:relative; text-align:center;}
    .theme-toggle{ position:absolute; right:14px; top:10px; border:0; background:transparent; color:#fff; padding:8px; cursor:pointer; font-weight:600; border-radius:8px;}
    main{ display:flex; align-items:flex-start; justify-content:center; padding:30px 16px; min-height:60vh; }
    .card{ width:100%; max-width:920px; background:var(--card); padding:22px; border-radius:12px; box-shadow:0 8px 24px rgba(10,10,10,0.06); }
    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:820px){ .grid{ grid-template-columns:1fr } }
    label{ display:block; font-size:0.9rem; margin-bottom:6px; font-weight:600; color:var(--text); }
    input, select, button { font-family:inherit; }
    input[type=text], input[type=email], input[type=tel], input[type=date], input[type=password], select {
      width:100%; padding:10px; border:1px solid #cfcfcf; border-radius:8px; background:transparent; color:inherit;
    }
    body.dark input, body.dark select{ border-color:#2c2f33; }
    .small{ padding:8px 10px; font-weight:600; border-radius:8px; border:none; background:var(--brand); color:#fff; cursor:pointer;}
    .small:disabled{ opacity:.6; cursor:not-allowed; }
    .helper{ font-size:0.85rem; color:var(--muted); margin-top:6px; }
    .msg{ font-size:0.9rem; margin-top:6px; min-height:1.1em; }
    .msg.success{ color:var(--success); }
    .msg.error{ color:var(--error); }
    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:12px; }
    footer{ background:#222; color:#fff; text-align:center; padding:18px; margin-top:30px; }
    .full{ grid-column:1/-1; }
    .pw-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:600px){ .pw-row{ grid-template-columns:1fr } }
    .controls-row{ display:flex; gap:8px; align-items:center; }
    .hidden{ display:none !important; }
    .center{ text-align:center; }
  </style>
</head>

<body>
  <header>
    <h1 style="margin:0; font-size:1.15rem;">Edu Connect â€” Student Registration</h1>
    <button id="toggleTheme" class="theme-toggle" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
  </header>

  <main>
    <div class="card" id="cardRoot">
      <!-- If logged in, we'll show a message; otherwise show the form -->
      <div id="loggedInBox" class="hidden">
        <p id="loggedInMsg" class="msg success"></p>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
          <a href="homepage.html" class="small" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">Go to Homepage</a>
          <button id="logoutBtn" class="small" style="background:#d9534f;">Logout</button>
        </div>
      </div>

      <form id="regForm" novalidate>
        <div id="formArea">
          <div class="grid">
            <div>
              <label for="name">Full Name *</label>
              <input id="name" name="name" type="text" placeholder="Enter full name" required />
              <div id="nameMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="dob">Date of Birth *</label>
              <input id="dob" name="dob" type="date" required />
              <div id="dobMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="gender">Gender *</label>
              <select id="gender" name="gender" required>
                <option value="">Select gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
              <div id="genderMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="course">Course / Branch *</label>
              <select id="course" name="course" required>
                <option value="">Select course</option>
                <option>B.Tech</option>
                <option>MCA</option>
                <option>MBA</option>
                <option>B.Pharma</option>
                <option>Others</option>
              </select>
              <div id="courseMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="email">Email Address *</label>
              <input id="email" name="email" type="email" placeholder="example@mail.com" required />
              <div id="emailMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="phone">Phone Number *</label>
              <input id="phone" name="phone" type="tel" inputmode="numeric" pattern="[0-9]{10}" placeholder="10-digit mobile" required />
              <div id="phoneMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="father">Father's Name *</label>
              <input id="father" name="father" type="text" placeholder="Father's name" required />
              <div id="fatherMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="mother">Mother's Name *</label>
              <input id="mother" name="mother" type="text" placeholder="Mother's name" required />
              <div id="motherMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="admissionCategory">Admission Category *</label>
              <select id="admissionCategory" name="admissionCategory" required>
                <option value="">Select admission type</option>
                <option>Direct</option>
                <option>Counselling</option>
              </select>
              <div id="admissionMsg" class="msg" aria-live="polite"></div>
            </div>

            <div>
              <label for="rollNo">Counselling Roll No.</label>
              <input id="rollNo" name="rollNo" type="text" placeholder="If applicable" />
            </div>

            <div>
              <label for="section">Section</label>
              <input id="section" name="section" type="text" placeholder="Section (e.g. A, B)" />
            </div>

            <div>
              <label for="blood">Blood Group</label>
              <input id="blood" name="blood" type="text" placeholder="e.g. A+, O-" />
            </div>

            <div class="full pw-row">
              <div>
                <label for="password">Password *</label>
                <input id="password" name="password" type="password" placeholder="Create a password" required />
                <div id="passwordMsg" class="msg" aria-live="polite"></div>
              </div>

              <div>
                <label for="confirmPassword">Confirm Password *</label>
                <input id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm password" required />
                <div id="confirmPasswordMsg" class="msg" aria-live="polite"></div>
              </div>
            </div>

            <!-- Email OTP -->
            <div class="full">
              <label>Verify Email (OTP)</label>
              <div class="controls-row">
                <input id="otpEmailInput" type="text" placeholder="Enter email OTP" style="flex:1" inputmode="numeric" />
                <button id="genEmailOtp" type="button" class="small">Generate</button>
                <button id="verifyEmailOtp" type="button" class="small">Verify</button>
              </div>
              <div id="otpEmailMsg" class="msg" aria-live="polite"></div>
            </div>

            <!-- Phone OTP -->
            <div class="full">
              <label>Verify Phone (OTP)</label>
              <div class="controls-row">
                <input id="otpPhoneInput" type="text" placeholder="Enter phone OTP" style="flex:1" inputmode="numeric" />
                <button id="genPhoneOtp" type="button" class="small">Generate</button>
                <button id="verifyPhoneOtp" type="button" class="small">Verify</button>
              </div>
              <div id="otpPhoneMsg" class="msg" aria-live="polite"></div>
            </div>

          </div> <!-- grid -->

          <div class="actions">
            <button id="resetBtn" type="button" style="background:#e9ecef;color:#000;padding:10px 14px;border-radius:8px;border:1px solid #ddd">Reset</button>
            <button id="submitBtn" type="submit" style="padding:10px 14px;border-radius:8px">Register</button>
          </div>

          <p id="formMsg" class="msg" aria-live="polite" style="margin-top:12px"></p>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <p style="margin:8px 0">Contacts â€” Mobile: 9192631770 â€¢ Email: <a href="mailto:educonnect04@gmail.com" style="color:#9fd1ff">educonnect04@gmail.com</a></p>
    <p style="margin:0">&copy; 2025 EduConnect. All rights reserved.</p>
  </footer>

  <script>
  (function(){
    const API_BASE = '/edu_connect/api.php';
    const toggle = document.getElementById('toggleTheme');
    const savedTheme = localStorage.getItem('edu_theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    function applyTheme(theme){
      if(theme === 'dark') document.body.classList.add('dark');
      else document.body.classList.remove('dark');
      toggle.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    }
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
    toggle.addEventListener('click', ()=>{
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('edu_theme', isDark ? 'dark' : 'light');
      applyTheme(isDark ? 'dark' : 'light');
    });

    // Elements & state
    const form = document.getElementById('regForm');
    const formMsg = document.getElementById('formMsg');
    const resetBtn = document.getElementById('resetBtn');

    const state = { emailOtp:null, phoneOtp:null, emailVerified:false, phoneVerified:false };

    // Input helpers
    const ids = ['name','dob','gender','course','email','phone','father','mother','admissionCategory','rollNo','section','blood','password','confirmPassword'];
    function $(id){ return document.getElementById(id); }
    function showMsg(el, text, type){ if(!el) return; el.textContent = text || ''; el.className = 'msg ' + (type||''); }
    function clearFieldMsgs(){ const toClear = ['nameMsg','dobMsg','genderMsg','emailMsg','phoneMsg','fatherMsg','motherMsg','courseMsg','admissionMsg','otpEmailMsg','otpPhoneMsg','passwordMsg','confirmPasswordMsg','formMsg']; toClear.forEach(id=>{ const el=document.getElementById(id); if(el){ el.textContent=''; el.className='msg'; }}); }

    // OTP simulation helpers
    function randomOtp(){ return String(Math.floor(100000 + Math.random() * 900000)); }

    // Email OTP
    $('genEmailOtp').addEventListener('click', ()=>{
      const email = $('email').value.trim();
      if(!validateEmail(email)){ showMsg($('emailMsg'),'Enter a valid email before generating OTP','error'); return; }
      state.emailOtp = randomOtp(); state.emailVerified = false;
      showMsg($('otpEmailMsg'), `Simulated OTP sent to ${email} â€” ${state.emailOtp}`, 'success');
    });
    $('verifyEmailOtp').addEventListener('click', ()=>{
      if(!state.emailOtp){ showMsg($('otpEmailMsg'),'Generate an OTP first','error'); return; }
      if($('otpEmailInput').value.trim() === state.emailOtp){ state.emailVerified = true; showMsg($('otpEmailMsg'),'Email verified âœ…','success'); }
      else showMsg($('otpEmailMsg'),'Incorrect OTP','error');
    });

    // Phone OTP
    $('genPhoneOtp').addEventListener('click', ()=>{
      const phone = $('phone').value.trim();
      if(!validatePhone(phone)){ showMsg($('phoneMsg'),'Enter a valid 10-digit phone before generating OTP','error'); return; }
      state.phoneOtp = randomOtp(); state.phoneVerified = false;
      showMsg($('otpPhoneMsg'), `Simulated OTP sent to ${phone} â€” ${state.phoneOtp}`, 'success');
    });
    $('verifyPhoneOtp').addEventListener('click', ()=>{
      if(!state.phoneOtp){ showMsg($('otpPhoneMsg'),'Generate an OTP first','error'); return; }
      if($('otpPhoneInput').value.trim() === state.phoneOtp){ state.phoneVerified = true; showMsg($('otpPhoneMsg'),'Phone verified âœ…','success'); }
      else showMsg($('otpPhoneMsg'),'Incorrect OTP','error');
    });

    // Basic validators
    function validateEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function validatePhone(p){ return /^[0-9]{10}$/.test(p); }

    // Register & login helpers
    async function registerApi(payload){
      try{
        const res = await fetch(API_BASE + '?route=register', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(()=>null);
        return { status: res.status, ok: res.ok, json };
      }catch(err){
        return { error: String(err) };
      }
    }
    async function loginApi(payload){
      try{
        const res = await fetch(API_BASE + '?route=login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(()=>null);
        return { status: res.status, ok: res.ok, json };
      }catch(err){
        return { error: String(err) };
      }
    }

    // Check session (show logged-in state)
    async function checkSession(){
      try{
        const res = await fetch(API_BASE + '?route=me', { credentials: 'same-origin' });
        const j = await res.json().catch(()=>null);
        if(j && j.success){
          // hide form and show logged-in box
          document.getElementById('formArea').classList.add('hidden');
          const loggedBox = document.getElementById('loggedInBox');
          loggedBox.classList.remove('hidden');
          $('loggedInMsg').textContent = `You are already logged in as ${j.data.full_name || j.data.email}.`;
          return true;
        } else {
          // ensure form visible
          document.getElementById('formArea').classList.remove('hidden');
          document.getElementById('loggedInBox').classList.add('hidden');
          return false;
        }
      }catch(err){
        // network error -> keep form visible
        return false;
      }
    }

    // Logout button
    $('logoutBtn').addEventListener('click', async ()=>{
      try{
        await fetch(API_BASE + '?route=logout', { method:'POST', credentials:'same-origin' });
      }catch(e){}
      // just refresh UI
      location.reload();
    });

    // Form submit
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      clearFieldMsgs();
      showMsg(formMsg,'','');

      // collect inputs
      const name = $('name').value.trim();
      const dob = $('dob').value;
      const gender = $('gender').value;
      const course = $('course').value;
      const email = $('email').value.trim().toLowerCase();
      const phone = $('phone').value.trim();
      const father = $('father').value.trim();
      const mother = $('mother').value.trim();
      const admission = $('admissionCategory').value;
      const rollNo = $('rollNo').value.trim();
      const section = $('section').value.trim();
      const blood = $('blood').value.trim();
      const password = $('password').value;
      const confirmPassword = $('confirmPassword').value;

      let ok = true;
      if(!name){ showMsg($('nameMsg'),'Name is required','error'); ok=false; }
      if(!dob){ showMsg($('dobMsg'),'Date of birth is required','error'); ok=false; }
      if(!gender){ showMsg($('genderMsg'),'Please select gender','error'); ok=false; }
      if(!validateEmail(email)){ showMsg($('emailMsg'),'Valid email is required','error'); ok=false; }
      if(!validatePhone(phone)){ showMsg($('phoneMsg'),'Valid 10-digit phone is required','error'); ok=false; }
      if(!father){ showMsg($('fatherMsg'),"Father's name is required",'error'); ok=false; }
      if(!mother){ showMsg($('motherMsg'),"Mother's name is required",'error'); ok=false; }
      if(!course){ showMsg($('courseMsg'),'Please select course','error'); ok=false; }
      if(!admission){ showMsg($('admissionMsg'),'Please select admission category','error'); ok=false; }
      if(!password || password.length < 6){ showMsg($('passwordMsg'),'Password required (min 6 chars)','error'); ok=false; }
      if(password !== confirmPassword){ showMsg($('confirmPasswordMsg'),'Passwords do not match','error'); ok=false; }
      if(!state.emailVerified){ showMsg($('otpEmailMsg'),'Please verify email with OTP','error'); ok=false; }
      if(!state.phoneVerified){ showMsg($('otpPhoneMsg'),'Please verify phone with OTP','error'); ok=false; }

      if(!ok){ showMsg(formMsg,'Please fix errors and try again','error'); return; }

      // send register request
      showMsg(formMsg,'Registeringâ€¦');
      const regPayload = { email, password, full_name: name };
      const regResult = await registerApi(regPayload);
      if(regResult.error){
        showMsg(formMsg,'Network or server error during registration: ' + regResult.error,'error');
        return;
      }
      if(!regResult.json){
        showMsg(formMsg,'Server returned non-JSON response. Check api_debug.log','error');
        return;
      }
      if(!regResult.json.success){
        showMsg(formMsg, regResult.json.error || 'Registration failed','error');
        return;
      }

      // on success, server auto-logged (api sets session). But to be safe, call login endpoint to ensure session cookie set.
      const loginResult = await loginApi({ email, password });
      if(loginResult.error){
        showMsg(formMsg,'Registered but login failed (network): ' + loginResult.error,'error');
        return;
      }
      if(!loginResult.json || !loginResult.json.success){
        // registration succeeded but login failed - show message but let them login manually
        showMsg(formMsg, 'Registered but login failed: ' + (loginResult.json && loginResult.json.error ? loginResult.json.error : 'unknown'),'error');
        return;
      }

      // Save profile locally (placeholder) â€” change to server-side when you add profile endpoint
      const profile = { name,dob,gender,course,email,phone,father,mother,admission,rollNo,section,blood,created_at:new Date().toISOString() };
      try{ localStorage.setItem('edu_profile_' + email, JSON.stringify(profile)); }catch(e){ /* ignore */ }

      showMsg(formMsg,'Registration successful âœ… â€” you are now logged in. Redirectingâ€¦','success');
      setTimeout(()=>{ window.location.href = '/edu_connect/homepage.html'; }, 900);
    });

    // Reset
    resetBtn.addEventListener('click', ()=>{
      form.reset();
      state.emailOtp = state.phoneOtp = null;
      state.emailVerified = state.phoneVerified = false;
      clearFieldMsgs();
    });

    // init - check if already logged in
    (async function init(){
      await checkSession();
    })();
  })();
  </script>
</body>
</html>
